# Install-Mise.ps1
# Script to install mise directly using apt and capture activation output

# Determine the location of utility scripts
$scriptPath = $PSScriptRoot
if (-not $scriptPath) {
    # If running interactively and $PSScriptRoot is not available
    $scriptPath = Split-Path -Parent $MyInvocation.MyCommand.Path
}

$utilsPath = Join-Path (Split-Path -Parent $scriptPath) "Utils"
$utilsModulePath = Join-Path $utilsPath "Utils.psm1"

# Import the entire Utils module
Import-Module $utilsModulePath -Force

# Function to install mise using apt
function Install-Mise {
    # Check if mise is already installed
    Write-Host "Checking if mise is already installed..." -ForegroundColor Cyan
    $miseExists = bash -c "command -v mise || echo 'not-found'"

    if ($miseExists -ne "not-found") {
        Write-Host "mise is already installed at: $miseExists" -ForegroundColor Green
        $reinstall = Read-Host "Would you like to reinstall it? (y/N)"
        if ($reinstall -ne "y" -and $reinstall -ne "Y") {
            Write-Host "Skipping installation, continuing with configuration..." -ForegroundColor Yellow
            return $true
        }
    }
    
    # Install mise using apt
    Write-Host "Installing mise via apt..." -ForegroundColor Cyan
    
    # Get sudo password at the beginning
    $sudoPassword = Read-Host "Enter sudo password" -AsSecureString
    $password = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto(
        [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($sudoPassword)
    )
    
    $installCommands = @(
        "echo '$password' | sudo -S apt update -y && sudo apt install -y gpg wget curl",
        "echo '$password' | sudo -S install -dm 755 /etc/apt/keyrings",
        "wget -qO - https://mise.jdx.dev/gpg-key.pub | gpg --dearmor | sudo tee /etc/apt/keyrings/mise-archive-keyring.gpg 1> /dev/null",
        "echo 'deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.gpg arch=amd64] https://mise.jdx.dev/deb stable main' | sudo tee /etc/apt/sources.list.d/mise.list",
        "echo '$password' | sudo -S apt update",
        "echo '$password' | sudo -S apt install -y mise"
    )
    
    foreach ($cmd in $installCommands) {
        # Don't show the command since it contains the password
        Write-Host "Running installation step..." -ForegroundColor DarkGray
        bash -c "$cmd"
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Error during installation step." -ForegroundColor Red
            $continueAnyway = Read-Host "Continue anyway? (y/N)"
            if ($continueAnyway -ne "y" -and $continueAnyway -ne "Y") {
                # Clear the password variable for security
                $password = $null
                return $false
            }
        }
    }
    
    # Clear the password variable for security
    $password = $null
    
    # Verify installation
    $miseVersion = bash -c "mise --version || echo 'not-found'"
    if ($miseVersion -match "mise") {
        Write-Host "mise successfully installed: $miseVersion" -ForegroundColor Green
        return $true
    } else {
        Write-Host "Installation may have failed. Please check if mise is installed." -ForegroundColor Red
        return $false
    }
}

# Function to capture shell activation output
function Get-MiseActivation {
    param (
        [Parameter(Mandatory = $true)]
        [ValidateSet("bash", "zsh")]
        [string]$Shell
    )
    
    Write-Host "Capturing mise activation for $Shell..." -ForegroundColor Cyan
    $activationOutput = bash -c "mise activate $Shell"
    return $activationOutput
}

# Function to create activation scripts
function New-MiseActivationScript {
    param (
        [Parameter(Mandatory = $true)]
        [string]$BashContent,
        
        [Parameter(Mandatory = $true)]
        [string]$ZshContent
    )
    
    # Create shell config directories
    bash -c "mkdir -p ~/.bashrc.d ~/.zshrc.d"
    
    # Write the activation scripts directly
    Write-Host "Creating mise activation scripts..." -ForegroundColor Cyan
    
    # Create bash activation script
    $bashActivationContent = @"
#!/bin/bash
# Mise en Place activation script for Bash
# Generated by Install-Mise.ps1

$BashContent
"@
    
    # Create zsh activation script
    $zshActivationContent = @"
#!/bin/zsh
# Mise en Place activation script for Zsh
# Generated by Install-Mise.ps1

$ZshContent
"@
    
    # Write scripts to temp files first
    $tempDir = [System.IO.Path]::GetTempPath()
    $bashTempPath = Join-Path $tempDir "mise-bash-activation.sh"
    $zshTempPath = Join-Path $tempDir "mise-zsh-activation.sh"
    
    Set-Content -Path $bashTempPath -Value $bashActivationContent
    Set-Content -Path $zshTempPath -Value $zshActivationContent
    
    # Copy them to the appropriate locations
    bash -c "cat '$bashTempPath' > ~/.bashrc.d/20-mise.sh"
    bash -c "cat '$zshTempPath' > ~/.zshrc.d/20-mise.sh"
    
    # Make scripts executable
    bash -c "chmod +x ~/.bashrc.d/20-mise.sh ~/.zshrc.d/20-mise.sh"
    
    # Clean up temp files
    Remove-Item -Path $bashTempPath, $zshTempPath -Force -ErrorAction SilentlyContinue
}

# Main execution flow
function Install-MiseComplete {
    # Step 1: Install mise if needed
    $installSuccess = Install-Mise
    if (-not $installSuccess) {
        Write-Host "Installation failed or was cancelled. Exiting." -ForegroundColor Red
        return
    }
    
    # Step 2: Capture activation outputs
    $bashActivation = Get-MiseActivation -Shell "bash"
    $zshActivation = Get-MiseActivation -Shell "zsh"
    
    # Step 3: Create activation scripts
    New-MiseActivationScript -BashContent $bashActivation -ZshContent $zshActivation
    
    # Step 4: Set up shell configurations
    Deploy-Bashrcd
    Deploy-Zshrcd
    
    # Step 5: Output completion message
    Write-Host "`nMise installation and configuration complete!" -ForegroundColor Green
    Write-Host "`nTo start using mise right away:" -ForegroundColor Yellow
    Write-Host "  bash -l" -ForegroundColor White
    
    Write-Host "`nTo create a .mise.toml file in your project:" -ForegroundColor Yellow
    Write-Host "  cd ~/projects/myproject && mise init" -ForegroundColor White
}

# Execute main function
Install-MiseComplete
